parameters:
  TaskctlVersion: 1.5.3

steps:
  - template: checkout-source.yml

  # Install taskctl so that the tests can be run
  - task: Bash@3
    displayName: "Install: Taskctl"
    inputs:
      targetType: inline
      script: |
        sudo wget https://github.com/Ensono/taskctl/releases/download/v${{ parameters.TaskctlVersion }}/taskctl_${{ parameters.TaskctlVersion }}_linux_amd64.tar.gz -O /tmp/taskctl.tar.gz
        sudo tar zxf /tmp/taskctl.tar.gz -C /usr/local/bin taskctl

  - task: Bash@3
    displayName: "Install: GitHub CLI"
    inputs:
      targetType: inline
      script: |
        set -e
        sudo mkdir -p -m 755 /etc/apt/keyrings
        out=$(mktemp)
        wget -nv -O "$out" https://cli.github.com/packages/githubcli-archive-keyring.gpg
        cat "$out" | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
        sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg

        sudo mkdir -p -m 755 /etc/apt/sources.list.d
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
          | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null

        sudo apt update
        sudo apt install gh -y
