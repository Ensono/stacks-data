tasks:
  buildnumber:
    context: powershell
    description: Update the build number
    command:
      - Update-BuildNumber

  poetry:setup:
    context: powershell
    description: Ensure that the poetry is configured correctly
    command:
      - |
        poetry config virtualenvs.create true --local
        poetry config virtualenvs.in-project true --local
        poetry config installer.max-workers 10
        python3 -m poetry install --no-interaction

  poetry:lint:
    context: powershell
    description: Perform Pre-Commit linting
    command:
      - git config --global --add safe.directory /app && python3 -m poetry run pre-commit run --all-files

  poetry:test:
    context: powershell
    description: Ensure that the environment is configured correctly
    command:
      - |
        apt-get update
        apt-get install openjdk-8-jdk-headless -qq
        python3 -m poetry run pytest

  poetry:build:
    context: powershell
    description: Ensure that the environment is configured correctly
    command:
      - git config --global --add safe.directory /app && poetry build

  publish:github:
    context: powershell
    description: Publish Release to GitHub
    command:
      - Publish-GitHubRelease -artifactsList "$env:ARTIFACTS_LIST"
    env:
      generateReleaseNotes: $true
      # PUBLISH_RELEASE: $true

  debug:env:
    context: powershell
    description: Debugging task to show the environment variables in the container
    command:
      - dir env:/

  debug:location:
    context: powershell
    command:
      - Write-Host "***** DEBUG *****" && get-childitem -filter "*opencover.xml" -recurse

  debug:sleep:
    context: powershell
    command:
      - echo "Sleeping for {{ .sleep }}"
      - sleep {{ .sleep }}
    variables:
      sleep: 30
